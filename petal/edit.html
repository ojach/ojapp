<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Petal - 個人ページ編集</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    margin: 0;
    padding: 0;
    background: #fafafa;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica";
    color: #222;
  }

  .container {
    max-width: 640px;
    margin: auto;
    padding: 20px;
  }

  h2 {
    font-size: 20px;
    margin-top: 28px;
    margin-bottom: 12px;
  }

  input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 15px;
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  textarea {
    height: 90px;
    resize: none;
  }

  .save-btn {
    width: 100%;
    margin-top: 30px;
    padding: 14px;
    background: #2bb7ff;
    color: white;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    border: none;
  }

  /* SNSリンク管理 */
  .sns-list {
    margin-top: 10px;
  }

  .sns-item {
    background: #fff;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
  }

  .sns-item input {
    margin-top: 4px;
  }

  .sns-delete {
    margin-top: 6px;
    background: #ff6464;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
  }

  .block-box {
    background: #fff;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 14px;
    border: 1px solid #ddd;
  }

  .toggle {
    margin-top: 8px;
  }

</style>
</head>

<body>
<div class="container">

  <h1>Petal 個人ページ編集</h1>

  <!-- アイコン画像 -->
 <!-- アイコン -->
<h2>アイコン画像</h2>
<img id="icon_preview" src="" style="width:90px;height:90px;border-radius:50%;object-fit:cover;">
<br><br>
<input type="file" id="icon_file" accept="image/*">
<button onclick="uploadIcon()">画像アップロード</button>


  <!-- 表示名 -->
  <h2>表示名</h2>
  <input id="display_name" placeholder="名前">

  <!-- 一言プロフィール -->
  <h2>一言プロフィール</h2>
  <textarea id="bio" placeholder="短い自己紹介"></textarea>

  <!-- SNSリンク管理 -->
  <h2>SNSリンク</h2>
  <button onclick="addSNS()">＋ SNSリンクを追加</button>
  <div id="sns_list" class="sns-list"></div>

  <!-- OJapp 名刺リンク（手動入力）-->
  <h2>OJapp 名刺リンク</h2>
  <input id="namecard_link" placeholder="例: https://ojapp.app/card/@あなた">

  <!-- 無料 3 ブロック -->
  <h2>無料カード（3ブロック）</h2>
  <div id="blocks"></div>
  
<div id="card_area"></div>
  <!-- Petal メッセージ設定 -->
  <h2>Petal メッセージ設定</h2>
  <label><input type="checkbox" id="petal_enabled"> 受け取る</label>

  <!-- 一覧表示設定 -->
  <h2>一覧表示</h2>
  <label><input type="checkbox" id="page_public"> 一覧に載せる</label>

  <button class="save-btn" onclick="saveProfile()">保存する</button>
</div>

<script>
let PROFILE = null;
let snsList = [];
let blocks = [
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" }
];

/* -----------------------------
   ページ読み込み → プロフィール取得
----------------------------- */
(async () => {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要です");

  const username = localStorage.getItem("username");
  const res = await fetch(`/api/get_profile/${username}`);
  const json = await res.json();

  if (!json.ok) return alert("読み込みエラー");

  PROFILE = json.profile;

  // 基本情報をセット
  document.getElementById("display_name").value = PROFILE.display_name || "";
  document.getElementById("bio").value = PROFILE.bio || "";
  document.getElementById("namecard_link").value = PROFILE.namecard_link || "";
  document.getElementById("petal_enabled").checked = PROFILE.petal_enabled === 1;
  document.getElementById("page_public").checked = PROFILE.page_public === 1;

  // アイコン
  if (PROFILE.icon_url) {
    document.getElementById("icon_preview").src = PROFILE.icon_url;
  }

  // SNS
  snsList = PROFILE.sns_links || [];
  renderSNS();

  // Blocks（無料カード 3つ）
  if (PROFILE.blocks) {
    blocks = PROFILE.blocks;
  }
  renderBlocks();
})();

/* -----------------------------
   SNS UI
----------------------------- */
function addSNS() {
  snsList.push({ url: "" });
  renderSNS();
}

function deleteSNS(i) {
  snsList.splice(i, 1);
  renderSNS();
}

function renderSNS() {
  const wrap = document.getElementById("sns_list");
  wrap.innerHTML = "";

  snsList.forEach((sns, i) => {
    const div = document.createElement("div");
    div.className = "sns-item";
    div.innerHTML = `
      <input value="${sns.url}" placeholder="URL"
             oninput="snsList[${i}].url = this.value">
      <button class="sns-delete" onclick="deleteSNS(${i})">削除</button>
    `;
    wrap.appendChild(div);
  });
}

/* -----------------------------
   ブロック UI (3つ)
----------------------------- */
function renderBlocks() {
  const area = document.getElementById("card_area");
  area.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const b = blocks[i] || {};

    area.innerHTML += `
      <div class="block-editor" style="padding:16px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px;">
        <h4>ブロック ${i + 1}</h4>

        <label>タイトル</label>
        <input type="text" id="block_title_${i}" class="input" value="${b.title || ""}">

        <label>本文</label>
        <textarea id="block_text_${i}" class="textarea">${b.text || ""}</textarea>

        <label>画像（アップロード or URL）</label>

        <!-- 画像プレビュー -->
        <img id="block_preview_${i}" 
             src="${b.img || ""}" 
             style="width:120px; height:auto; display:${b.img ? "block" : "none"}; margin-bottom:8px; border-radius:8px;">

        <!-- URL入力（手動入力も可） -->
        <input type="text" id="block_img_${i}" class="input" 
               value="${b.img || ""}" 
               placeholder="画像URL（または下のアップロード）"
               oninput="blocks[${i}].img = this.value">

        <!-- ファイル選択 -->
        <input type="file" id="block_file_${i}" accept="image/*" onchange="uploadBlockImage(${i})">

        <label>リンクURL</label>
        <input type="text" id="block_link_${i}" class="input" value="${b.link || ""}">
      </div>
    `;
  }
}


/* -----------------------------
   アイコンアップロード
----------------------------- */
async function uploadIcon() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要です");

  const file = document.getElementById("icon_file").files[0];
  if (!file) return alert("画像を選択してください");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);

  const res = await fetch("/api/upload_icon", {
    method: "POST",
    body: fd
  });

  const json = await res.json();
  console.log("UPLOAD RESPONSE:", json);

  if (!json.ok || !json.url) {
    return alert("アップロード失敗");
  }

  // プレビュー更新
  document.getElementById("icon_preview").src = json.url;

  // 保存用
  localStorage.setItem("icon_url", json.url);

  alert("アイコンを更新しました！");
}

/* -----------------------------
   保存処理 (/api/update_profile)
----------------------------- */
async function saveProfile() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要");

  const icon_url =
    localStorage.getItem("icon_url") ||
    (PROFILE ? PROFILE.icon_url : "");

  // ★ UIから blocks[] を再構築する
  const newBlocks = [];
  for (let i = 0; i < 3; i++) {
    newBlocks.push({
      title: document.getElementById(`block_title_${i}`).value.trim(),
      text: document.getElementById(`block_text_${i}`).value.trim(),
      img: document.getElementById(`block_img_${i}`).value.trim(),
      link: document.getElementById(`block_link_${i}`).value.trim()
    });
  }

  const body = {
    user_id: uid,
    icon_url,
    display_name: document.getElementById("display_name").value.trim(),
    bio: document.getElementById("bio").value.trim(),
    namecard_link: document.getElementById("namecard_link").value.trim(),
    sns_links: snsList,
    blocks: newBlocks,
    petal_enabled: document.getElementById("petal_enabled").checked ? 1 : 0,
    page_public: document.getElementById("page_public").checked ? 1 : 0
  };

  const res = await fetch("/api/update_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();

  if (json.ok) {
    alert("保存しました！");
    location.href = `/petal/@${localStorage.getItem("username")}`;
  } else {
    alert("保存エラー");
  }
}

  async function uploadBlockImage(i) {
  const uid = Number(localStorage.getItem("user_id"));
  const file = document.getElementById(`block_file_${i}`).files[0];

  if (!file) return;

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);
  fd.append("block_index", i);

  const res = await fetch("/api/upload_block_image", {
    method: "POST",
    body: fd
  });

  const json = await res.json();

  if (!json.ok) {
    return alert("画像アップロード失敗");
  }

  // URL を blocks[] に保存
  blocks[i].img = json.url;

  // プレビュー更新
  const preview = document.getElementById(`block_preview_${i}`);
  preview.src = json.url;
  preview.style.display = "block";

  // URL入力欄にも反映
  document.getElementById(`block_img_${i}`).value = json.url;

  alert("ブロック画像を更新しました！");
}

</script>



</body>
</html>
