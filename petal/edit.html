<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Petal - 個人ページ編集</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    margin: 0;
    padding: 0;
    background: #fafafa;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica";
    color: #222;
  }

  .container {
    max-width: 640px;
    margin: auto;
    padding: 20px;
  }

  h2 {
    font-size: 20px;
    margin-top: 28px;
    margin-bottom: 12px;
  }

  input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 15px;
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  textarea {
    height: 90px;
    resize: none;
  }

  .save-btn {
    width: 100%;
    margin-top: 30px;
    padding: 14px;
    background: #2bb7ff;
    color: white;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    border: none;
  }

  .sns-list {
    margin-top: 10px;
  }

  .sns-item {
    background: #fff;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
  }

  .sns-item input {
    margin-top: 4px;
  }

  .sns-delete {
    margin-top: 6px;
    background: #ff6464;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
  }

  .sns-section {
    margin-top: 20px;
  }

  #add_sns_btn {
    padding: 10px 14px;
    font-size: 15px;
    border-radius: 8px;
    background: #fff;
    border: 1px solid #ddd;
    cursor: pointer;
  }

  .block-box {
    background: #fff;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 14px;
    border: 1px solid #ddd;
  }
#sns_list {
  display: flex !important;
  flex-direction: column;
  gap: 12px;
  min-height: 20px;
}
.sns-accordion {
  margin-top: 12px;
}

.sns-toggle-btn {
  width: 100%;
  padding: 12px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 15px;
  text-align: left;
}

.sns-panel {
  display: none;      /* 折りたたみ */
  margin-top: 10px;
}

.sns-item {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

.sns-item input {
  flex: 1;
}

.sns-delete {
  background: #ff6464;
  color: #fff;
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
}
#sns_toggle_btn {
  display: block;
  width: 100%;
  padding: 12px 14px;
  font-size: 16px;
  font-weight: 600;
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 12px;
  text-align: center;
  color: #2bb7ff;
  margin-top: 10px;
  cursor: pointer;
  transition: 0.15s ease;
}

#sns_toggle_btn:active {
  transform: scale(0.97);
  background: #f0faff;
}
.sns-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
  margin-bottom: 10px;
}

.sns-row input {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.sns-del-btn {
  background: #ff6464;
  color: #fff;
  padding: 10px 12px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}
.sns-edit-btn {
  width: 100%;
  padding: 10px 14px;
  font-size: 16px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  text-align: left;
}

.sns-add-btn {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-radius: 8px;
  text-align: center;
  font-weight: 600;
}

.sns-row input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
}

</style>
</head>

<body>
<div class="container">

  <h1>Petal 個人ページ編集</h1>

  <h2>アイコン画像</h2>
  <img id="icon_preview" src="" style="width:90px;height:90px;border-radius:50%;object-fit:cover;">
  <br><br>
  <input type="file" id="icon_file" accept="image/*">
  <button onclick="uploadIcon()">画像アップロード</button>

  <h2>表示名</h2>
  <input id="display_name" placeholder="名前">

  <h2>一言プロフィール</h2>
  <textarea id="bio" placeholder="短い自己紹介"></textarea>

<button id="sns_toggle_btn" class="sns-edit-btn">SNSリンクを編集 ▼</button>

<div id="sns_panel" style="display:none; margin-top:10px;">
  
  <button id="sns_add_btn" class="sns-add-btn">＋ 追加</button>

  <div id="sns_rows">
    <!-- 10枠生成 -->
    <div id="sns_row_0" class="sns-row" style="display:none;">
      <input id="sns_input_0" type="text" placeholder="URL">
    </div>

    <div id="sns_row_1" class="sns-row" style="display:none;">
      <input id="sns_input_1" type="text" placeholder="URL">
    </div>

    <div id="sns_row_2" class="sns-row" style="display:none;">
      <input id="sns_input_2" type="text" placeholder="URL">
    </div>

    <div id="sns_row_3" class="sns-row" style="display:none;">
      <input id="sns_input_3" type="text" placeholder="URL">
    </div>

    <div id="sns_row_4" class="sns-row" style="display:none;">
      <input id="sns_input_4" type="text" placeholder="URL">
    </div>

    <div id="sns_row_5" class="sns-row" style="display:none;">
      <input id="sns_input_5" type="text" placeholder="URL">
    </div>

    <div id="sns_row_6" class="sns-row" style="display:none;">
      <input id="sns_input_6" type="text" placeholder="URL">
    </div>

    <div id="sns_row_7" class="sns-row" style="display:none;">
      <input id="sns_input_7" type="text" placeholder="URL">
    </div>

    <div id="sns_row_8" class="sns-row" style="display:none;">
      <input id="sns_input_8" type="text" placeholder="URL">
    </div>

    <div id="sns_row_9" class="sns-row" style="display:none;">
      <input id="sns_input_9" type="text" placeholder="URL">
    </div>

  </div>
</div>




  <h2>OJapp 名刺リンク</h2>
  <input id="namecard_link" placeholder="例: https://ojapp.app/card/@あなた">

  <h2>無料カード（3ブロック）</h2>
  <div id="card_area"></div>

  <h2>Petal メッセージ設定</h2>
  <label><input type="checkbox" id="petal_enabled"> 受け取る</label>

  <h2>一覧表示</h2>
  <label><input type="checkbox" id="page_public"> 一覧に載せる</label>

  <button class="save-btn" onclick="saveProfile()">保存する</button>
</div>

<script>
/* -----------------------------------
   グローバル変数
--------------------------------------*/
let PROFILE = null;
let snsList = [];   // ← 宣言はここ1回のみ
let blocks = [
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" }
];

/* -----------------------------------
   DOMロード完了後
--------------------------------------*/
document.addEventListener("DOMContentLoaded", () => {

  // 折りたたみ
  document.getElementById("sns_toggle_btn").addEventListener("click", () => {
    const panel = document.getElementById("sns_panel");
    panel.style.display = panel.style.display === "none" ? "block" : "none";
  });

  // ＋ボタン
  document.getElementById("sns_add_btn").addEventListener("click", () => {
    for (let i = 0; i < 10; i++) {
      const row = document.getElementById(`sns_row_${i}`);
      const input = document.getElementById(`sns_input_${i}`);

      if (row.style.display === "none" || input.value.trim() === "") {
        row.style.display = "block";
        return;
      }
    }
    alert("SNSリンクは最大10件までです！");
  });

  loadProfile();
});

/* -----------------------------------
   プロフィール取得
--------------------------------------*/
async function loadProfile() {
  const res = await fetch("/api/get_profile/@me");
  if (!res.ok) return alert("ログインが必要です");

  const json = await res.json();
  if (!json.ok) return alert("読み込みエラー");

  PROFILE = json.profile;

  document.getElementById("display_name").value = PROFILE.display_name || "";
  document.getElementById("bio").value = PROFILE.bio || "";
  document.getElementById("namecard_link").value = PROFILE.namecard_link || "";
  document.getElementById("petal_enabled").checked = PROFILE.petal_enabled === 1;
  document.getElementById("page_public").checked = PROFILE.page_public === 1;

  if (PROFILE.icon_url) {
    document.getElementById("icon_preview").src = PROFILE.icon_url;
  }

  /* SNS データ整形 */
  try {
    if (typeof PROFILE.sns_links === "string") {
      snsList = JSON.parse(PROFILE.sns_links);
    } else if (Array.isArray(PROFILE.sns_links)) {
      snsList = PROFILE.sns_links;
    } else {
      snsList = [];
    }
  } catch (e) { snsList = []; }

  renderSNS_Static();

  if (PROFILE.blocks) blocks = PROFILE.blocks;
  renderBlocks();
}

/* -----------------------------------
   SNS 静的 10枠 UI
--------------------------------------*/
function renderSNS_Static() {
  snsList = snsList.filter(s => s.url && s.url.trim() !== "");

  for (let i = 0; i < 10; i++) {
    const row = document.getElementById(`sns_row_${i}`);
    const input = document.getElementById(`sns_input_${i}`);

    if (i < snsList.length) {
      row.style.display = "block";
      input.value = snsList[i].url;
    } else {
      row.style.display = "none";
      input.value = "";
    }
  }
}


function clearSNS(i) {
  snsList[i] = { url: "" };
  renderSNS_Static();
}

/* 保存用 */
function getSNS_Data() {
  const result = [];

  for (let i = 0; i < 10; i++) {
    const v = document.getElementById(`sns_input_${i}`).value.trim();
    if (v !== "") result.push({ url: v });
  }

  return result;
}


/* -----------------------------------
   ブロック表示
--------------------------------------*/
function renderBlocks() {
  const area = document.getElementById("card_area");
  area.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const b = blocks[i] || {};

    area.innerHTML += `
      <div class="block-editor" style="padding:16px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px;">
        <h4>ブロック ${i + 1}</h4>

        <label>タイトル</label>
        <input type="text" id="block_title_${i}" value="${b.title || ""}">

        <label>本文</label>
        <textarea id="block_text_${i}">${b.text || ""}</textarea>

        <label>画像（アップロード or URL）</label>
        <img id="block_preview_${i}"
             src="${b.img || ""}"
             style="width:120px; height:auto; display:${b.img ? "block" : "none"}; margin-bottom:8px; border-radius:8px;">

        <input type="text" id="block_img_${i}"
               value="${b.img || ""}"
               placeholder="画像URL（またはアップロード）"
               oninput="blocks[${i}].img = this.value">

        <input type="file" id="block_file_${i}" accept="image/*" onchange="uploadBlockImage(${i})">

        <label>リンクURL</label>
        <input type="text" id="block_link_${i}" value="${b.link || ""}">
      </div>
    `;
  }
}

/* -----------------------------------
   アイコンアップロード
--------------------------------------*/
async function uploadIcon() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要");

  const file = document.getElementById("icon_file").files[0];
  if (!file) return alert("ファイルを選択");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);

  const res = await fetch("/api/upload_icon", { method: "POST", body: fd });
  const json = await res.json();

  if (!json.ok) return alert("アップロード失敗");

  document.getElementById("icon_preview").src = json.url;
  localStorage.setItem("icon_url", json.url);
  alert("更新しました！");
}

/* -----------------------------------
   保存
--------------------------------------*/
async function saveProfile() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要");

  const newBlocks = [];
  for (let i = 0; i < 3; i++) {
    newBlocks.push({
      title: document.getElementById(`block_title_${i}`).value.trim(),
      text: document.getElementById(`block_text_${i}`).value.trim(),
      img: document.getElementById(`block_img_${i}`).value.trim(),
      link: document.getElementById(`block_link_${i}`).value.trim()
    });
  }

  const body = {
    user_id: uid,
    icon_url: localStorage.getItem("icon_url") || (PROFILE ? PROFILE.icon_url : ""),
    display_name: document.getElementById("display_name").value.trim(),
    bio: document.getElementById("bio").value.trim(),
    namecard_link: document.getElementById("namecard_link").value.trim(),
    sns_links: getSNS_Data(),
    blocks: newBlocks,
    petal_enabled: document.getElementById("petal_enabled").checked ? 1 : 0,
    page_public: document.getElementById("page_public").checked ? 1 : 0
  };

  const res = await fetch("/api/update_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();
  if (!json.ok) return alert("保存エラー");

  alert("保存しました！");
  location.href = `/petal/@${localStorage.getItem("username")}`;
}

/* -----------------------------------
   ブロック画像アップロード
--------------------------------------*/
async function uploadBlockImage(i) {
  const uid = Number(localStorage.getItem("user_id"));
  const file = document.getElementById(`block_file_${i}`).files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);
  fd.append("block_index", i);

  const res = await fetch("/api/upload_block_image", {
    method: "POST",
    body: fd
  });

  const json = await res.json();
  if (!json.ok) return alert("アップロード失敗");

  blocks[i].img = json.url;
  document.getElementById(`block_preview_${i}`).src = json.url;
  document.getElementById(`block_preview_${i}`).style.display = "block";
  document.getElementById(`block_img_${i}`).value = json.url;

  alert("更新しました！");
}


</script>

</body>
</html>

