<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Petal - 個人ページ編集</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    margin: 0;
    padding: 0;
    background: #fafafa;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica";
    color: #222;
  }

  .container {
    max-width: 640px;
    margin: auto;
    padding: 20px;
  }

  h2 {
    font-size: 20px;
    margin-top: 28px;
    margin-bottom: 12px;
  }

  input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 15px;
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  textarea {
    height: 90px;
    resize: none;
  }

  .save-btn {
    width: 100%;
    margin-top: 30px;
    padding: 14px;
    background: #2bb7ff;
    color: white;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    border: none;
  }

  .sns-list {
    margin-top: 10px;
  }

  .sns-item {
    background: #fff;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
  }

  .sns-item input {
    margin-top: 4px;
  }

  .sns-delete {
    margin-top: 6px;
    background: #ff6464;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
  }

  .sns-section {
    margin-top: 20px;
  }

  #add_sns_btn {
    padding: 10px 14px;
    font-size: 15px;
    border-radius: 8px;
    background: #fff;
    border: 1px solid #ddd;
    cursor: pointer;
  }

  .block-box {
    background: #fff;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 14px;
    border: 1px solid #ddd;
  }
  /* Safari が #sns_list の高さを 0 に潰すバグ対策 */
#sns_list {
  display: block;
  min-height: 1px;
  padding-top: 1px;        /* margin collapse 防止 */
  overflow: visible;       /* Safari の高さ計算バグ回避 */
  position: relative;      /* 高さ 0 化を確実に阻止 */
  z-index: 1;
}

/* SNS アイテムが描画されない問題の保険 */
.sns-item {
  display: block;
  position: relative;
  z-index: 2;
}
</style>
</head>

<body>
<div class="container">

  <h1>Petal 個人ページ編集</h1>

  <h2>アイコン画像</h2>
  <img id="icon_preview" src="" style="width:90px;height:90px;border-radius:50%;object-fit:cover;">
  <br><br>
  <input type="file" id="icon_file" accept="image/*">
  <button onclick="uploadIcon()">画像アップロード</button>

  <h2>表示名</h2>
  <input id="display_name" placeholder="名前">

  <h2>一言プロフィール</h2>
  <textarea id="bio" placeholder="短い自己紹介"></textarea>

  <h2>SNSリンク</h2>
  <div class="sns-section">
    <button id="add_sns_btn">＋ SNSリンクを追加</button>
    <div id="sns_list" class="sns-list"></div>
  </div>

  <h2>OJapp 名刺リンク</h2>
  <input id="namecard_link" placeholder="例: https://ojapp.app/card/@あなた">

  <h2>無料カード（3ブロック）</h2>
  <div id="card_area"></div>

  <h2>Petal メッセージ設定</h2>
  <label><input type="checkbox" id="petal_enabled"> 受け取る</label>

  <h2>一覧表示</h2>
  <label><input type="checkbox" id="page_public"> 一覧に載せる</label>

  <button class="save-btn" onclick="saveProfile()">保存する</button>
</div>

<script>
let PROFILE = null;
let snsList = [];
let blocks = [
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" }
];

/* -------------------------
   DOM読み込み後に実行
------------------------- */
document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("add_sns_btn").addEventListener("click", () => {
    snsList.push({ url: "" });
    renderSNS();
  });

  loadProfile();
});

/* -------------------------
   プロフィール取得
------------------------- */
async function loadProfile() {
  const res = await fetch("/api/get_profile/@me");
  if (!res.ok) return alert("ログインが必要です");

  const json = await res.json();
  if (!json.ok) return alert("読み込みエラー");

  PROFILE = json.profile;

  document.getElementById("display_name").value = PROFILE.display_name || "";
  document.getElementById("bio").value = PROFILE.bio || "";
  document.getElementById("namecard_link").value = PROFILE.namecard_link || "";
  document.getElementById("petal_enabled").checked = PROFILE.petal_enabled === 1;
  document.getElementById("page_public").checked = PROFILE.page_public === 1;

  if (PROFILE.icon_url) {
    document.getElementById("icon_preview").src = PROFILE.icon_url;
  }

  snsList = Array.isArray(PROFILE.sns_links) ? [...PROFILE.sns_links] : [];
  renderSNS();

  if (PROFILE.blocks) blocks = PROFILE.blocks;
  renderBlocks();
}

/* -------------------------
   SNS UI
------------------------- */
function renderSNS() {
  const wrap = document.getElementById("sns_list");

  // ① 初期化（Safari は innerHTML = "" のみだと再描画しない事があるので2段階）
  while (wrap.firstChild) wrap.removeChild(wrap.firstChild);

  // ② 空欄除外（上書きではなく新しい配列を返す → Safari が破壊されない方法）
  snsList = snsList.filter(s => (s.url || "").trim() !== "");

  // ③ 要素を createElement で生成（Safari でも100%表示）
  snsList.forEach((sns, i) => {

    const item = document.createElement("div");
    item.className = "sns-item";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "URL";
    input.value = sns.url;

    input.addEventListener("input", () => {
      snsList[i].url = input.value;
    });

    const del = document.createElement("button");
    del.className = "sns-delete";
    del.textContent = "削除";

    del.addEventListener("click", () => {
      snsList.splice(i, 1);
      renderSNS();
    });

    item.appendChild(input);
    item.appendChild(del);

    wrap.appendChild(item);
  });

  // ④ Safari が描画しないときの“強制リフロー”
  wrap.style.display = "none";
  void wrap.offsetHeight;
  wrap.style.display = "";
}

/* -------------------------
   ブロック UI
------------------------- */
function renderBlocks() {
  const area = document.getElementById("card_area");
  area.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const b = blocks[i] || {};

    area.innerHTML += `
      <div class="block-editor" style="padding:16px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px;">
        <h4>ブロック ${i + 1}</h4>

        <label>タイトル</label>
        <input type="text" id="block_title_${i}" value="${b.title || ""}">

        <label>本文</label>
        <textarea id="block_text_${i}">${b.text || ""}</textarea>

        <label>画像（アップロード or URL）</label>

        <img id="block_preview_${i}" 
             src="${b.img || ""}" 
             style="width:120px; height:auto; display:${b.img ? "block" : "none"}; margin-bottom:8px; border-radius:8px;">

        <input type="text" id="block_img_${i}" 
               value="${b.img || ""}" 
               placeholder="画像URL（または下のアップロード）"
               oninput="blocks[${i}].img = this.value">

        <input type="file" id="block_file_${i}" accept="image/*" onchange="uploadBlockImage(${i})">

        <label>リンクURL</label>
        <input type="text" id="block_link_${i}" value="${b.link || ""}">
      </div>
    `;
  }
}

/* -------------------------
   アイコンアップロード
------------------------- */
async function uploadIcon() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要");

  const file = document.getElementById("icon_file").files[0];
  if (!file) return alert("ファイルを選択");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);

  const res = await fetch("/api/upload_icon", { method: "POST", body: fd });
  const json = await res.json();

  if (!json.ok) return alert("アップロード失敗");

  document.getElementById("icon_preview").src = json.url;
  localStorage.setItem("icon_url", json.url);
  alert("更新しました！");
}

/* -------------------------
   保存
------------------------- */
async function saveProfile() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ログインが必要");

  const newBlocks = [];
  for (let i = 0; i < 3; i++) {
    newBlocks.push({
      title: document.getElementById(`block_title_${i}`).value.trim(),
      text: document.getElementById(`block_text_${i}`).value.trim(),
      img: document.getElementById(`block_img_${i}`).value.trim(),
      link: document.getElementById(`block_link_${i}`).value.trim()
    });
  }

  const body = {
    user_id: uid,
    icon_url: localStorage.getItem("icon_url") || (PROFILE ? PROFILE.icon_url : ""),
    display_name: document.getElementById("display_name").value.trim(),
    bio: document.getElementById("bio").value.trim(),
    namecard_link: document.getElementById("namecard_link").value.trim(),
    sns_links: snsList.filter(s => s.url && s.url.trim() !== ""),
    blocks: newBlocks,
    petal_enabled: document.getElementById("petal_enabled").checked ? 1 : 0,
    page_public: document.getElementById("page_public").checked ? 1 : 0
  };

  const res = await fetch("/api/update_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();
  if (!json.ok) return alert("保存エラー");

  alert("保存しました！");
  location.href = `/petal/@${localStorage.getItem("username")}`;
}

/* -------------------------
   ブロック画像アップロード
------------------------- */
async function uploadBlockImage(i) {
  const uid = Number(localStorage.getItem("user_id"));
  const file = document.getElementById(`block_file_${i}`).files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);
  fd.append("block_index", i);

  const res = await fetch("/api/upload_block_image", {
    method: "POST",
    body: fd
  });

  const json = await res.json();
  if (!json.ok) return alert("アップロード失敗");

  blocks[i].img = json.url;
  document.getElementById(`block_preview_${i}`).src = json.url;
  document.getElementById(`block_preview_${i}`).style.display = "block";
  document.getElementById(`block_img_${i}`).value = json.url;

  alert("更新しました！");
}

</script>

</body>
</html>

