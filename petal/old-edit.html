<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Petal - å€‹äººãƒšãƒ¼ã‚¸ç·¨é›†</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    margin: 0;
    padding: 0;
    background: #fafafa;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica";
    color: #222;
  }

  .container {
    max-width: 640px;
    margin: auto;
    padding: 20px;
  }

  h2 {
    font-size: 20px;
    margin-top: 28px;
    margin-bottom: 12px;
  }

  input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 15px;
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  textarea {
    height: 90px;
    resize: none;
  }

  .save-btn {
    width: 100%;
    margin-top: 30px;
    padding: 14px;
    background: #2bb7ff;
    color: white;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    border: none;
  }

  .sns-list {
    margin-top: 10px;
  }

  .sns-item {
    background: #fff;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
  }

  .sns-item input {
    margin-top: 4px;
  }

  .sns-delete {
    margin-top: 6px;
    background: #ff6464;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
  }

  .sns-section {
    margin-top: 20px;
  }

  #add_sns_btn {
    padding: 10px 14px;
    font-size: 15px;
    border-radius: 8px;
    background: #fff;
    border: 1px solid #ddd;
    cursor: pointer;
  }

  .block-box {
    background: #fff;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 14px;
    border: 1px solid #ddd;
  }
#sns_list {
  display: flex !important;
  flex-direction: column;
  gap: 12px;
  min-height: 20px;
}
.sns-accordion {
  margin-top: 12px;
}

.sns-toggle-btn {
  width: 100%;
  padding: 12px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 15px;
  text-align: left;
}

.sns-panel {
  display: none;      /* æŠ˜ã‚ŠãŸãŸã¿ */
  margin-top: 10px;
}

.sns-item {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

.sns-item input {
  flex: 1;
}

.sns-delete {
  background: #ff6464;
  color: #fff;
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
}

</style>
</head>

<body>
<div class="container">

  <h1>Petal å€‹äººãƒšãƒ¼ã‚¸ç·¨é›†</h1>

  <h2>ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ</h2>
  <img id="icon_preview" src="" style="width:90px;height:90px;border-radius:50%;object-fit:cover;">
  <br><br>
  <input type="file" id="icon_file" accept="image/*">
  <button onclick="uploadIcon()">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>

  <h2>è¡¨ç¤ºå</h2>
  <input id="display_name" placeholder="åå‰">

  <h2>ä¸€è¨€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <textarea id="bio" placeholder="çŸ­ã„è‡ªå·±ç´¹ä»‹"></textarea>

 <h2>SNSãƒªãƒ³ã‚¯</h2>

<div class="sns-accordion">
  <button id="sns_toggle_btn" class="sns-toggle-btn">
    SNSãƒªãƒ³ã‚¯ã‚’ç·¨é›†
  </button>

  <div id="sns_panel" class="sns-panel">

    <div class="sns-item" id="sns_row_0">
      <input type="text" id="sns_input_0" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(0)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_1">
      <input type="text" id="sns_input_1" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(1)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_2">
      <input type="text" id="sns_input_2" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(2)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_3">
      <input type="text" id="sns_input_3" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(3)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_4">
      <input type="text" id="sns_input_4" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(4)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_5">
      <input type="text" id="sns_input_5" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(5)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_6">
      <input type="text" id="sns_input_6" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(6)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_7">
      <input type="text" id="sns_input_7" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(7)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_8">
      <input type="text" id="sns_input_8" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(8)">ğŸ—‘ï¸</button>
    </div>
    <div class="sns-item" id="sns_row_9">
      <input type="text" id="sns_input_9" placeholder="URLã‚’å…¥åŠ›">
      <button class="sns-delete" onclick="clearSNS(9)">ğŸ—‘ï¸</button>
    </div>

  </div>
</div>


  <h2>OJapp ååˆºãƒªãƒ³ã‚¯</h2>
  <input id="namecard_link" placeholder="ä¾‹: https://ojapp.app/card/@ã‚ãªãŸ">

  <h2>ç„¡æ–™ã‚«ãƒ¼ãƒ‰ï¼ˆ3ãƒ–ãƒ­ãƒƒã‚¯ï¼‰</h2>
  <div id="card_area"></div>

  <h2>Petal ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š</h2>
  <label><input type="checkbox" id="petal_enabled"> å—ã‘å–ã‚‹</label>

  <h2>ä¸€è¦§è¡¨ç¤º</h2>
  <label><input type="checkbox" id="page_public"> ä¸€è¦§ã«è¼‰ã›ã‚‹</label>

  <button class="save-btn" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
</div>

<script>
let PROFILE = null;
let snsList = [];
let blocks = [
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" },
  { title: "", text: "", img: "", link: "" }
];

/* -------------------------
   DOMèª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œ
------------------------- */
document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("add_sns_btn").addEventListener("click", () => {
    snsList.push({ url: "" });


    renderSNS();
  });

  loadProfile();
});

/* -------------------------
   ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
------------------------- */
async function loadProfile() {
  const res = await fetch("/api/get_profile/@me");
  if (!res.ok) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");

  const json = await res.json();
  if (!json.ok) return alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼");

  PROFILE = json.profile;

  document.getElementById("display_name").value = PROFILE.display_name || "";
  document.getElementById("bio").value = PROFILE.bio || "";
  document.getElementById("namecard_link").value = PROFILE.namecard_link || "";
  document.getElementById("petal_enabled").checked = PROFILE.petal_enabled === 1;
  document.getElementById("page_public").checked = PROFILE.page_public === 1;

  if (PROFILE.icon_url) {
    document.getElementById("icon_preview").src = PROFILE.icon_url;
  }

// SNS ãƒªãƒ³ã‚¯èª­ã¿è¾¼ã¿
try {
  if (typeof PROFILE.sns_links === "string") {
    snsList = JSON.parse(PROFILE.sns_links);
  } else if (Array.isArray(PROFILE.sns_links)) {
    snsList = PROFILE.sns_links;
  } else {
    snsList = [];
  }
} catch(e) {
  snsList = [];
}

// é™çš„10æ ã¸åæ˜ 
renderSNS_Static();



  if (PROFILE.blocks) blocks = PROFILE.blocks;
  renderBlocks();
}

/* -------------------------
   SNS UI
------------------------- */
// SNS æœ€å¤§10å€‹é™çš„æ 
let snsList = [];  // { url: "" } ã®é…åˆ—

// ------------------------------------
// æŠ˜ã‚ŠãŸãŸã¿é–‹é–‰
// ------------------------------------
document.getElementById("sns_toggle_btn").addEventListener("click", () => {
  const panel = document.getElementById("sns_panel");
  panel.style.display = (panel.style.display === "none" || panel.style.display === "")
    ? "block" : "none";
});

// ------------------------------------
// SNS åˆæœŸåæ˜ ï¼ˆPROFILEèª­ã¿è¾¼ã¿å¾Œã«å‘¼ã¶ï¼‰
// ------------------------------------
function renderSNS_Static() {
  // 1) ç©ºæ¬„å‰Šé™¤
  snsList = snsList.filter(s => s.url && s.url.trim() !== "");

  // 2) 10æ ã«åæ˜ 
  for (let i = 0; i < 10; i++) {
    const row = document.getElementById(`sns_row_${i}`);
    const input = document.getElementById(`sns_input_${i}`);

    if (i < snsList.length) {
      row.style.display = "flex";
      input.value = snsList[i].url;
    } else {
      row.style.display = "none";
      input.value = "";
    }

    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    input.oninput = () => {
      snsList[i] = { url: input.value };
      renderSNS_Static(); // ç©ºæ¬„ãŒç¶šã„ãŸã‚‰éš ã™
    };
  }
}

// ------------------------------------
// å‰Šé™¤ãƒœã‚¿ãƒ³
// ------------------------------------
function clearSNS(i) {
  snsList[i] = { url: "" };
  renderSNS_Static();
}

// ------------------------------------
// ä¿å­˜æ™‚ã«å‘¼ã¶
// ------------------------------------
function getSNS_Data() {
  return snsList
    .filter(s => s.url && s.url.trim() !== "")
    .map(s => ({ url: s.url.trim() }));
}



/* -------------------------
   ãƒ–ãƒ­ãƒƒã‚¯ UI
------------------------- */
function renderBlocks() {
  const area = document.getElementById("card_area");
  area.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const b = blocks[i] || {};

    area.innerHTML += `
      <div class="block-editor" style="padding:16px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px;">
        <h4>ãƒ–ãƒ­ãƒƒã‚¯ ${i + 1}</h4>

        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" id="block_title_${i}" value="${b.title || ""}">

        <label>æœ¬æ–‡</label>
        <textarea id="block_text_${i}">${b.text || ""}</textarea>

        <label>ç”»åƒï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ or URLï¼‰</label>

        <img id="block_preview_${i}" 
             src="${b.img || ""}" 
             style="width:120px; height:auto; display:${b.img ? "block" : "none"}; margin-bottom:8px; border-radius:8px;">

        <input type="text" id="block_img_${i}" 
               value="${b.img || ""}" 
               placeholder="ç”»åƒURLï¼ˆã¾ãŸã¯ä¸‹ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰"
               oninput="blocks[${i}].img = this.value">

        <input type="file" id="block_file_${i}" accept="image/*" onchange="uploadBlockImage(${i})">

        <label>ãƒªãƒ³ã‚¯URL</label>
        <input type="text" id="block_link_${i}" value="${b.link || ""}">
      </div>
    `;
  }
}

/* -------------------------
   ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
------------------------- */
async function uploadIcon() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦");

  const file = document.getElementById("icon_file").files[0];
  if (!file) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);

  const res = await fetch("/api/upload_icon", { method: "POST", body: fd });
  const json = await res.json();

  if (!json.ok) return alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");

  document.getElementById("icon_preview").src = json.url;
  localStorage.setItem("icon_url", json.url);
  alert("æ›´æ–°ã—ã¾ã—ãŸï¼");
}

/* -------------------------
   ä¿å­˜
------------------------- */
async function saveProfile() {
  const uid = Number(localStorage.getItem("user_id"));
  if (!uid) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦");

  const newBlocks = [];
  for (let i = 0; i < 3; i++) {
    newBlocks.push({
      title: document.getElementById(`block_title_${i}`).value.trim(),
      text: document.getElementById(`block_text_${i}`).value.trim(),
      img: document.getElementById(`block_img_${i}`).value.trim(),
      link: document.getElementById(`block_link_${i}`).value.trim()
    });
  }

  const body = {
    user_id: uid,
    icon_url: localStorage.getItem("icon_url") || (PROFILE ? PROFILE.icon_url : ""),
    display_name: document.getElementById("display_name").value.trim(),
    bio: document.getElementById("bio").value.trim(),
    namecard_link: document.getElementById("namecard_link").value.trim(),
    sns_links: getSNS_Data(),
    blocks: newBlocks,
    petal_enabled: document.getElementById("petal_enabled").checked ? 1 : 0,
    page_public: document.getElementById("page_public").checked ? 1 : 0
  };

  const res = await fetch("/api/update_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();
  if (!json.ok) return alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼");

  alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
  location.href = `/petal/@${localStorage.getItem("username")}`;
}

/* -------------------------
   ãƒ–ãƒ­ãƒƒã‚¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
------------------------- */
async function uploadBlockImage(i) {
  const uid = Number(localStorage.getItem("user_id"));
  const file = document.getElementById(`block_file_${i}`).files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("file", file);
  fd.append("user_id", uid);
  fd.append("block_index", i);

  const res = await fetch("/api/upload_block_image", {
    method: "POST",
    body: fd
  });

  const json = await res.json();
  if (!json.ok) return alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");

  blocks[i].img = json.url;
  document.getElementById(`block_preview_${i}`).src = json.url;
  document.getElementById(`block_preview_${i}`).style.display = "block";
  document.getElementById(`block_img_${i}`).value = json.url;

  alert("æ›´æ–°ã—ã¾ã—ãŸï¼");
}

</script>

</body>
</html>

