<link rel="stylesheet" href="style.css">
<div class="header">
  <button class="back-btn" onclick="location.href='index.html'">â†</button>
  <div class="machine-name" id="machineName">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

  <div class="total-games">Gæ•°ï¼š<span id="totalGamesDisplay">0</span></div>

</div>

<div class="games-input">
  ç·å›è»¢æ•°ï¼š
  <input type="number" id="inputGames" placeholder="0" oninput="updateGames()">
</div>

<div class="counter-area">

  <!-- ã¶ã©ã† -->
  <div class="counter-block grape">
    <div class="label">ã¶ã©ã†</div>
    <button class="count-btn" onclick="addGrape()">+1</button>
    <div class="count-display">
      å›æ•°ï¼š<span id="grapeCount">0</span><br>
      ç¢ºç‡ï¼š<span id="grapeRate">1/0</span>
    </div>
  </div>

  <!-- BIG REG -->
  <div class="bonus-row">

    <div class="counter-block big">
      <div class="label">BIG</div>
      <button class="count-btn" onclick="addBig()">+1</button>
      <div class="count-display">å›æ•°ï¼š<span id="bigCount">0</span></div>
    </div>

    <div class="counter-block reg">
      <div class="label">REG</div>
      <button class="count-btn" onclick="addReg()">+1</button>
      <div class="count-display">å›æ•°ï¼š<span id="regCount">0</span></div>
    </div>

  </div>

</div>

<div class="result-area">
  <div class="result">BIGï¼š<span id="bigRate">1/0</span></div>
  <div class="result">REGï¼š<span id="regRate">1/0</span></div>
  <div class="result">åˆç®—ï¼š<span id="totalRate">1/0</span></div>
  <div class="result">ã¶ã©ã†ï¼š<span id="grapeRate2">1/0</span></div>
</div>
</div>
<!-- â–¼ å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹ãï¼‰ -->
<div id="kachiFooter">â–¼ è¨­å®šæ¨æ¸¬</div>

<!-- â–¼ ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆèƒŒæ™¯ï¼ˆã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼‰ -->
<div id="sheetOverlay"></div>

<!-- â–¼ ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆæœ¬ä½“ -->
<div id="sheet">
  <div id="sheetHandle"></div>
  <div id="resultTop" class="sheet-top">ã“ã“ã«æœ€ã‚‚é«˜ã„è¨­å®šãŒå‡ºã‚‹</div>
  <div id="resultList" class="sheet-list"></div>
  <button id="closeSheet" class="close-btn">é–‰ã˜ã‚‹</button>
</div>


  
<script>
// ========================================
// 1. æ©Ÿç¨®è¨­å®šãƒã‚¹ã‚¿ï¼ˆJSON ãƒã‚¹ã‚¿ï¼‰
// ========================================
const machineData = {
  im_juggler: {
    name: "ã‚¢ã‚¤ãƒ ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼EX",
    roles: {
      big:   {1:273, 2:270, 3:269, 4:268, 5:266, 6:255},
      reg:   {1:439, 2:399, 3:331, 4:315, 5:255, 6:255},
      grape: {1:6.02,2:6.02,3:6.02,4:5.78,5:5.78,6:5.66}
    }
  },

  neo_im_juggler: {
    name: "ãƒã‚ªã‚¢ã‚¤ãƒ ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼EX",
    roles: {
      big:   {1:273.1,2:269.7,3:269.7,4:259,5:259,6:255},
      reg:   {1:439.8,2:399.6,3:331,4:315.1,5:255,6:255},
      grape: {1:6.02,2:6.02,3:6.02,4:5.78,5:5.78,6:5.66}
    }
  },

  funky2: {
    name: "ãƒ•ã‚¡ãƒ³ã‚­ãƒ¼ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼2",
    roles: {
      big:   {1:266.4,2:259.0,3:256.0,4:249.2,5:240.1,6:219.9},
      reg:   {1:439.8,2:407.1,3:366.1,4:322.8,5:299.3,6:262.1},
      grape: {1:5.93,2:5.89,3:5.82,4:5.81,5:5.76,6:5.68}
    }
  },

  myj5: {
    name: "ãƒã‚¤ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼V",
    roles: {
      big:   {1:272.2,2:270.8,3:266.4,4:259.0,5:255.0,6:255.0},
      reg:   {1:439.8,2:399.6,3:331.0,4:315.1,5:255.0,6:255.0},
      grape: {1:6.03,2:6.03,3:6.00,4:5.94,5:5.90,6:5.85}
    }
  },

  happyv3: {
    name: "ãƒãƒƒãƒ”ãƒ¼ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼Vâ…¢",
    roles: {
      big:   {1:282.5,2:275.4,3:268.6,4:259.0,5:249.2,6:240.1},
      reg:   {1:431.2,2:390.0,3:336.0,4:315.1,5:292.6,6:273.1},
      grape: {1:6.32,2:6.29,3:6.25,4:6.16,5:6.10,6:6.05}
    }
  },

  gogo3: {
    name: "ã‚´ãƒ¼ã‚´ãƒ¼ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼3",
    roles: {
      big:   {1:282.5,2:275.4,3:268.6,4:259.0,5:249.2,6:240.1},
      reg:   {1:431.2,2:390.0,3:336.0,4:315.1,5:292.6,6:273.1},
      grape: {1:6.30,2:6.26,3:6.20,4:6.15,5:6.10,6:6.05}
    }
  },

  girlss: {
    name: "ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼ã‚¬ãƒ¼ãƒ«ã‚ºSS",
    roles: {
      big:   {1:273.1,2:270.8,3:269.7,4:259.0,5:255.0,6:255.0},
      reg:   {1:431.2,2:390.0,3:336.0,4:315.1,5:255.0,6:255.0},
      grape: {1:6.10,2:6.05,3:6.00,4:5.95,5:5.90,6:5.85}
    }
  },

  mrj: {
    name: "ãƒŸã‚¹ã‚¿ãƒ¼ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼",
    roles: {
      big:   {1:268.6,2:259.0,3:249.2,4:240.1,5:234.0,6:225.0},
      reg:   {1:431.2,2:390.0,3:336.0,4:315.1,5:292.6,6:273.1},
      grape: {1:6.15,2:6.09,3:6.02,4:5.97,5:5.88,6:5.79}
    }
  },

  umj: {
    name: "ã‚¦ãƒ«ãƒˆãƒ©ãƒŸãƒ©ã‚¯ãƒ«ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼",
    roles: {
      big:   {1:292.6,2:282.5,3:268.6,4:259.0,5:249.2,6:240.1},
      reg:   {1:431.2,2:390.0,3:336.0,4:315.1,5:292.6,6:273.1},
      grape: {1:6.35,2:6.30,3:6.25,4:6.20,5:6.10,6:6.00}
    }
  }
};

// ========================================
// 2. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ©Ÿç¨®IDã‚’å–å¾—
// ========================================
const id = new URLSearchParams(location.search).get("id");
const machine = machineData[id];

// æ©Ÿç¨®åã®è¡¨ç¤º
if (machine) {
  document.getElementById("machineName").innerText = machine.name;
} else {
  document.getElementById("machineName").innerText = "æ©Ÿç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
}

// ã“ã®æ©Ÿç¨®ã®è¨­å®šå€¤
let settingValues = machine.roles;

// ========================================
// 3. ã‚«ã‚¦ãƒ³ã‚¿å¤‰æ•°
// ========================================
let grape = 0;
let big = 0;
let reg = 0;
let totalGames = 0;

// ========================================
// 4. ç·å›è»¢æ•°å…¥åŠ›
// ========================================
function updateGames() {
  const val = parseInt(document.getElementById("inputGames").value || 0);
  totalGames = val;
  render();
}

// ========================================
// 5. ãƒœã‚¿ãƒ³ï¼ˆ+1ï¼‰
// ========================================
function addGrape() {
  grape++;
  render();
}
function addBig() {
  big++;
  render();
}
function addReg() {
  reg++;
  render();
}

// ========================================
// 6. ãƒªã‚»ãƒƒãƒˆ
// ========================================
function resetAll() {
  grape = 0;
  big = 0;
  reg = 0;
  totalGames = 0;
  document.getElementById("inputGames").value = "";
  render();
}

// ========================================
// 7. ç¢ºç‡è¨ˆç®—
// ========================================
function rate(count, games) {
  if (count === 0 || games === 0) return "1/0";
  return "1/" + (games / count).toFixed(2);
}

function totalBonusRate() {
  const t = big + reg;
  if (t === 0 || totalGames === 0) return "1/0";
  return "1/" + (totalGames / t).toFixed(2);
}

// ========================================
// 8. ç”»é¢åæ˜ 
// ========================================
function render() {
  document.getElementById("grapeCount").innerText = grape;
  document.getElementById("bigCount").innerText = big;
  document.getElementById("regCount").innerText = reg;
  document.getElementById("totalGamesDisplay").textContent = totalGames;


  document.getElementById("grapeRate").innerText = rate(grape, totalGames);
  document.getElementById("grapeRate2").innerText = rate(grape, totalGames);
  document.getElementById("bigRate").innerText = rate(big, totalGames);
  document.getElementById("regRate").innerText = rate(reg, totalGames);
  document.getElementById("totalRate").innerText = totalBonusRate();
}

  /* ================================
   ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆé–‹é–‰
================================ */
const footer = document.getElementById("kachiFooter");
const sheet = document.getElementById("sheet");
const sheetOverlay = document.getElementById("sheetOverlay");
const closeBtn = document.getElementById("closeSheet");

// é–‹ã
function openSheet() {
  document.getElementById("sheet").classList.add("active");
  document.getElementById("sheetOverlay").classList.add("active");
  updateSettingAnalysis();
}

// é–‰ã˜ã‚‹
function closeSheet() {
  document.getElementById("sheet").classList.remove("active");
  document.getElementById("sheetOverlay").classList.remove("active");
}

footer.addEventListener("click", openSheet);
sheetOverlay.addEventListener("click", closeSheet);
closeBtn.addEventListener("click", closeSheet);


/* ================================
   è¨­å®šæœŸå¾…åº¦ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆKachi+ï¼‰
================================ */

// å®Ÿæ¸¬ç¢ºç‡ï¼ˆcount=å›æ•°ã€games=ç·å›è»¢æ•°ï¼‰
function getActualRate(count, games) {
  if (count === 0 || games === 0) return 999999; // ç„¡é™å¤§ã®ä»£ã‚ã‚Š
  return games / count;
}

// ã‚ºãƒ¬ç‡ â†’ ä¿¡é ¼åº¦å¤‰æ›
function trustWeight(actual, theory) {
  if (actual === 999999) return 0.01;  // ãƒ‡ãƒ¼ã‚¿ãªã—ã¯æœ€å¼±

  const diffRate = Math.abs(actual - theory) / theory; // æ¯”ç‡å·®
  return 1 / (diffRate + 0.001); // å·®ãŒå°ã•ã„ã»ã©å¤§ãã„
}


function updateSettingAnalysis() {
  const top = document.getElementById("resultTop");
  const list = document.getElementById("resultList");

  const games = totalGames;
  const bigC = big;
  const regC = reg;
  const grapeC = grape;

  // ã‚²ãƒ¼ãƒ æ•°0ã¯ç„¡åŠ¹
  if (games === 0) {
    top.innerText = "ã‚²ãƒ¼ãƒ æ•°ãŒã‚ã‚Šã¾ã›ã‚“";
    list.innerHTML = "";
    return;
  }

  let scores = {};

  for (let s = 1; s <= 6; s++) {
    const theoBig = settingValues.big[s];
    const theoReg = settingValues.reg[s];
    const theoGrape = settingValues.grape[s];

    const actBig = getActualRate(bigC, games);
    const actReg = getActualRate(regC, games);
    const actGrape = getActualRate(grapeC, games);

    const wBig = trustWeight(actBig, theoBig);
    const wReg = trustWeight(actReg, theoReg);
    const wGrape = trustWeight(actGrape, theoGrape);

    const score = wBig * wReg * wGrape;
    scores[s] = score;
  }

  // æ­£è¦åŒ–
  const total = Object.values(scores).reduce((a, b) => a + b, 0);
  let resultPercent = {};
  for (let s = 1; s <= 6; s++) {
    resultPercent[s] = (scores[s] / total) * 100;
  }

  // æœ€å¤§è¨­å®š
  let bestSetting = 1;
  let bestValue = 0;
  for (let s = 1; s <= 6; s++) {
    if (resultPercent[s] > bestValue) {
      bestSetting = s;
      bestValue = resultPercent[s];
    }
  }

  // ãƒˆãƒƒãƒ—è¡¨ç¤º
  top.innerText = `ğŸ¯ è¨­å®š${bestSetting}ï¼ˆ${bestValue.toFixed(1)}%ï¼‰`;

  // ä¸€è¦§è¡¨ç¤º
 let html = "";
for (let s = 1; s <= 6; s++) {
  const percent = resultPercent[s].toFixed(1);
  if (s === bestSetting) {
    html += `<div class="best">è¨­å®š${s}ï¼š${percent}% â†æœ€é«˜</div>`;
  } else {
    html += `<div>è¨­å®š${s}ï¼š${percent}%</div>`;
  }
}
list.innerHTML = html;
}

render();
</script>

